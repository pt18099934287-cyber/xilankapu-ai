<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¥¿å…°å¡æ™®æ•°å­—å±•é¦†</title>
    <style>
        :root { --primary: #0d47a1; --accent: #c2185b; --bg: #f3f4f6; }
        body { font-family: 'Microsoft YaHei', sans-serif; background-color: var(--bg); margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        .container { background: white; padding: 40px; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); width: 100%; max-width: 650px; text-align: center; }
        h1 { margin: 0 0 10px 0; color: #333; }
        .subtitle { color: #666; font-size: 0.9em; margin-bottom: 30px; }
        
        .input-group { background: #eef2f6; padding: 20px; border-radius: 12px; display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; }
        input { padding: 12px 15px; border: 2px solid #ddd; border-radius: 8px; flex: 1; min-width: 200px; font-size: 16px; outline: none; }
        input:focus { border-color: var(--primary); }
        
        button { padding: 12px 20px; border: none; border-radius: 8px; font-size: 15px; font-weight: bold; cursor: pointer; color: white; white-space: nowrap; transition: 0.2s; }
        button:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-gen { background-color: var(--primary); }
        .btn-gallery { background-color: var(--accent); }
        
        .display-area { margin-top: 30px; min-height: 400px; border: 2px dashed #ddd; border-radius: 12px; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #fafafa; padding: 20px; position: relative; }
        
        img { max-width: 100%; max-height: 500px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); display: block; }
        .hidden { display: none !important; }
        .hint-text { color: #999; font-size: 12px; margin-top: 15px; }
        
        /* æ ‡ç­¾æç¤º */
        .tag-hint { margin-top: 10px; font-size: 12px; color: #666; }
    </style>
</head>
<body>

    <div class="container">
        <h1>è¥¿å…°å¡æ™® Â· çº¹æ ·ç”Ÿæˆå™¨</h1>
        <p class="subtitle">è¾“å…¥å…³é”®è¯æœç´¢ç»å…¸å›¾è°±ï¼Œæˆ–ç”Ÿæˆæ–°çº¹æ ·</p>

        <div class="input-group">
            <input type="text" id="keyword" placeholder="è¯•è¯•æœç´¢ï¼šæ¤…å­ã€çº¢è‰²ã€å®ç‰©...">
            <button class="btn-gen" onclick="generatePattern()">âœ¨ AI ç”Ÿæˆ</button>
            <button class="btn-gallery" id="btn-gallery" onclick="searchGallery()">ğŸ“š æœç´¢å›¾è°±</button>
        </div>

        <div id="ai-result" class="display-area">
            <p id="ai-status" style="color:#888;">è¾“å…¥å…³é”®è¯åç‚¹å‡»æŒ‰é’®</p>
            <img id="ai-img" class="hidden">
        </div>

        <div id="gallery-view" class="display-area hidden">
            <h3 style="margin-top:0; color:#444; margin-bottom: 20px;" id="gallery-title">ç»å…¸çº¹æ ·åº“</h3>
            <div id="single-image-container"></div>
            <p class="hint-text" id="gallery-hint"></p>
        </div>
        
        <div class="tag-hint">
            æ¨èæœç´¢è¯ï¼šå…«å‹¾ã€é˜³é›€ã€è™çº¹ã€å®ç‰©ã€çº¢è‰²ã€é»„è‰²ã€é”¯é½¿
        </div>
    </div>

    <script>
        const aiView = document.getElementById('ai-result');
        const galleryView = document.getElementById('gallery-view');
        const aiImg = document.getElementById('ai-img');
        const aiStatus = document.getElementById('ai-status');
        const singleImageContainer = document.getElementById('single-image-container');
        const galleryHint = document.getElementById('gallery-hint');

        let galleryImages = [];
        let currentImageIndex = 0;
        let lastSearchKeyword = "";

        // === åŠŸèƒ½ 1: AI ç”Ÿæˆ ===
        async function generatePattern() {
            galleryView.classList.add('hidden');
            aiView.classList.remove('hidden');
            const keyword = document.getElementById('keyword').value.trim();
            if(!keyword) { alert("è¯·è¾“å…¥å…³é”®è¯"); return; }

            aiImg.classList.add('hidden');
            aiStatus.innerHTML = "ğŸ§¶ æ­£åœ¨æŒ‡æŒ¥ AI ç¼–ç»‡çº¹æ ·ï¼Œè¯·ç¨å€™...";
            
            try {
                const res = await fetch('/generate', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({keyword: keyword})
                });
                const data = await res.json();
                if(data.success) {
                    aiImg.src = data.image_url;
                    aiImg.onload = () => { aiStatus.innerHTML = ""; aiImg.classList.remove('hidden'); };
                } else { aiStatus.innerHTML = "âŒ " + data.error; }
            } catch(e) { aiStatus.innerHTML = "âŒ ç½‘ç»œé”™è¯¯"; }
        }

        // === åŠŸèƒ½ 2: æœç´¢å¹¶æ˜¾ç¤ºç”»å»Š ===
        async function searchGallery() {
            aiView.classList.add('hidden');
            galleryView.classList.remove('hidden');

            const keyword = document.getElementById('keyword').value.trim();

            // é€»è¾‘ï¼šå¦‚æœæ˜¯æ–°å…³é”®è¯ï¼Œæˆ–è€…åˆ—è¡¨ä¸ºç©ºï¼Œå°±å»åå°è¯·æ±‚
            if (keyword !== lastSearchKeyword || galleryImages.length === 0) {
                lastSearchKeyword = keyword; // è®°å½•æœ¬æ¬¡æœç´¢è¯
                singleImageContainer.innerHTML = '<p style="color:#666">æ­£åœ¨ç¿»é˜…å›¾è°±...</p>';
                galleryHint.innerText = "";
                
                try {
                    const res = await fetch(`/get_gallery?keyword=${encodeURIComponent(keyword)}`);
                    const data = await res.json();
                    
                    if(data.success && data.images.length > 0) {
                        galleryImages = data.images;
                        currentImageIndex = 0; // é‡ç½®åˆ°ç¬¬ä¸€å¼ 
                        showCurrentImage(); // æ˜¾ç¤ºå›¾ç‰‡
                    } else {
                        galleryImages = [];
                        singleImageContainer.innerHTML = `<p style="color:#999">æ²¡æ‰¾åˆ°â€œ${keyword}â€ç›¸å…³çš„å›¾è°±<br>è¯·å°è¯•æœï¼šå…«å‹¾ã€èŠ±ã€å®ç‰©</p>`;
                        galleryHint.innerText = "";
                    }
                } catch(e) {
                    singleImageContainer.innerHTML = "<p>æœç´¢å¤±è´¥</p>";
                }
            } else {
                // å¦‚æœå…³é”®è¯æ²¡å˜ï¼Œè€Œä¸”æœ‰å›¾ -> åˆ‡æ¢ä¸‹ä¸€å¼ 
                if (galleryImages.length > 0) {
                    currentImageIndex++;
                    if (currentImageIndex >= galleryImages.length) {
                        currentImageIndex = 0; // å¾ªç¯å›åˆ°ç¬¬ä¸€å¼ 
                    }
                    showCurrentImage();
                }
            }
        }

        function showCurrentImage() {
            const imageUrl = galleryImages[currentImageIndex];
            singleImageContainer.innerHTML = `<img src="${imageUrl}" alt="ç»å…¸çº¹æ ·">`;
            
            // æ›´æ–°æç¤ºæ–‡å­—
            if (galleryImages.length > 1) {
                galleryHint.innerText = `æ‰¾åˆ° ${galleryImages.length} å¼ ç»“æœ (å½“å‰ç¬¬ ${currentImageIndex + 1} å¼ ) - ç‚¹å‡»æŒ‰é’®æŸ¥çœ‹ä¸‹ä¸€å¼ `;
            } else {
                galleryHint.innerText = "ä»…æ‰¾åˆ° 1 å¼ ç»“æœ";
            }
        }
    </script>
</body>
</html>
